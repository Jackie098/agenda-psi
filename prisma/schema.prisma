// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  PATIENT
  PSYCHOLOGIST
}

enum GuideStatus {
  ACTIVE
  COMPLETED
  EXPIRED
}

enum LinkStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum RequestedBy {
  PATIENT
  PSYCHOLOGIST
}

enum RegisteredBy {
  PATIENT
  PSYCHOLOGIST
}

enum ActivityType {
  FACIAL
  SESSION
  GUIDE_EXPIRED
  GUIDE_CLOSED
  GUIDE_CREATED
}

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  whatsapp  String   @unique
  role      UserRole
  createdAt DateTime @default(now())

  patient      Patient?
  psychologist Psychologist?

  @@map("users")
}

model Patient {
  id        String   @id @default(cuid())
  userId    String   @unique
  balance   Int      @default(0) // Pode ser negativo
  createdAt DateTime @default(now())

  user                     User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  guides                   Guide[]
  facialRecords            FacialRecord[]
  sessions                 Session[]
  psychologistReferences   PsychologistReference[]
  patientPsychologistLinks PatientPsychologistLink[]
  activityLogs             ActivityLog[]

  @@map("patients")
}

model Psychologist {
  id        String   @id @default(cuid())
  userId    String   @unique
  createdAt DateTime @default(now())

  user                     User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions                 Session[]
  linkedReferences         PsychologistReference[]
  psychologistPatientLinks PatientPsychologistLink[]

  @@map("psychologists")
}

model Company {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())

  guides Guide[]

  @@map("companies")
}

model Guide {
  id             String      @id @default(cuid())
  number         String      @unique
  totalCredits   Int // 4 ou 8 tipicamente
  usedCredits    Int         @default(0)
  expirationDate DateTime    @db.Date
  status         GuideStatus @default(ACTIVE)
  patientId      String
  companyId      String
  createdAt      DateTime    @default(now())

  patient       Patient        @relation(fields: [patientId], references: [id], onDelete: Cascade)
  company       Company        @relation(fields: [companyId], references: [id])
  facialRecords FacialRecord[]

  @@index([patientId])
  @@index([companyId])
  @@index([status])
  @@map("guides")
}

model FacialRecord {
  id         String   @id @default(cuid())
  recordedAt DateTime @default(now())
  patientId  String
  guideId    String
  createdAt  DateTime @default(now())

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  guide   Guide   @relation(fields: [guideId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([guideId])
  @@index([recordedAt])
  @@map("facial_records")
}

model Session {
  id                      String       @id @default(cuid())
  scheduledAt             DateTime
  duration                Int // 30 ou 50 minutos
  creditsUsed             Int // 1 ou 2 cr√©ditos
  patientId               String
  psychologistId          String?
  psychologistReferenceId String?
  registeredBy            RegisteredBy
  createdAt               DateTime     @default(now())

  patient               Patient                @relation(fields: [patientId], references: [id], onDelete: Cascade)
  psychologist          Psychologist?          @relation(fields: [psychologistId], references: [id])
  psychologistReference PsychologistReference? @relation(fields: [psychologistReferenceId], references: [id])

  @@index([patientId])
  @@index([psychologistId])
  @@index([scheduledAt])
  @@map("sessions")
}

model PsychologistReference {
  id                   String   @id @default(cuid())
  name                 String
  patientId            String
  linkedPsychologistId String?
  createdAt            DateTime @default(now())

  patient            Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  linkedPsychologist Psychologist? @relation(fields: [linkedPsychologistId], references: [id])
  sessions           Session[]

  @@unique([patientId, linkedPsychologistId])
  @@index([patientId])
  @@index([linkedPsychologistId])
  @@map("psychologist_references")
}

model PatientPsychologistLink {
  id             String      @id @default(cuid())
  patientId      String
  psychologistId String
  status         LinkStatus  @default(PENDING)
  requestedBy    RequestedBy
  createdAt      DateTime    @default(now())
  respondedAt    DateTime?

  patient      Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  psychologist Psychologist @relation(fields: [psychologistId], references: [id], onDelete: Cascade)

  @@unique([patientId, psychologistId])
  @@index([patientId])
  @@index([psychologistId])
  @@index([status])
  @@map("patient_psychologist_links")
}

model ActivityLog {
  id          String       @id @default(cuid())
  type        ActivityType
  description String
  metadata    Json?
  occurredAt  DateTime
  patientId   String
  createdAt   DateTime     @default(now())

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([type])
  @@index([occurredAt])
  @@map("activity_logs")
}
